<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>燕三条 工場の祭典地圖</title>
    <!-- Import Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Import Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <!-- Import Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100">

    <div id="app" class="flex flex-col md:flex-row h-screen">
        <!-- Sidebar -->
        <div class="w-full md:w-1/3 lg:w-1/4 xl:w-1/5 bg-white shadow-lg flex flex-col">
            <div class="p-4 border-b space-y-4">
                <!-- Language switcher -->
                <div>
                    <select id="language-switcher" class="w-full p-2 border border-gray-300 rounded-md">
                        <option value="zh-TW">繁體中文</option>
                        <option value="ja">日本語</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div>
                    <h1 data-lang-key="appTitle" class="text-2xl font-bold text-gray-800"></h1>
                    <p data-lang-key="appSubtitle" class="text-gray-600 mt-1 text-sm"></p>
                </div>
                 <!-- Search Input -->
                <div class="relative">
                    <input type="text" id="search-input" class="w-full p-2 pl-4 pr-10 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" />
                    <button id="clear-search-btn" class="absolute inset-y-0 right-0 px-3 text-gray-500 hover:text-gray-800 hidden">×</button>
                </div>
        
            </div>
            <div id="factory-list" class="space-y-1 p-4 overflow-y-auto flex-grow">
                <!-- Factory list will be generated by JavaScript -->
            </div>
        </div>
        
        <!-- Map Container -->
        <div class="flex-grow relative">
            <div id="map"></div>
        </div>
    </div>

    <!-- AI Planner Modal -->
    <div id="ai-planner-modal-overlay" class="hidden">
        <div id="ai-planner-modal" class="bg-white rounded-xl shadow-2xl overflow-hidden">
            <div class="p-6">
                <h2 data-lang-key="modalTitle" class="text-2xl font-bold text-gray-900"></h2>
                <p data-lang-key="modalDesc" class="mt-2 text-gray-600"></p>
                <p data-lang-key="modalExample" class="mt-1 text-xs text-gray-500"></p>
                
                <textarea id="user-prompt" class="w-full mt-4 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="4"></textarea>
                
                <div class="mt-4 flex justify-end space-x-3">
                    <button id="close-ai-planner-btn" data-lang-key="modalClose" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300"></button>
                    <button id="generate-plan-btn" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 flex items-center">
                        <span id="generate-plan-btn-text" data-lang-key="modalGenerate"></span>
                        <div id="loading-spinner" class="loader ml-2 hidden"></div>
                    </button>
                </div>
            </div>
            <div id="plan-result" class="p-6 bg-gray-50 border-t border-gray-200 max-h-[40vh] overflow-y-auto">
                <!-- AI-generated plan will be displayed here -->
            </div>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Import factory data from external file -->
    <script src="./factory_data.js"></script>

    <script>
        // --- Translations Data ---
        const translations = {
            'en': {
                appTitle: 'Tsubame-Sanjo Factory Festival', appSubtitle: 'Click a factory below to locate it on the map.', openPlannerBtn: 'Create a Tour Plan with AI',
                searchPlaceholder: 'Search for factories...', filterTitle: 'Category Filter', selectAll: 'Select All', deselectAll: 'Deselect All',
                modalTitle: 'AI Tour Planner', modalDesc: 'Enter your interests, time, companions, etc. The AI will propose a perfect tour plan for you.',
                modalExample: 'e.g., "Want to see knife making", "A half-day tour", "Recommended for families"', modalPlaceholder: 'Enter your preferences here...',
                modalClose: 'Close', modalGenerate: 'Generate Plan', modalGenerating: 'Generating...',
                errorPrompt: 'Please enter your preferences.', errorAPI: 'An error occurred while generating the plan. Please try again.',
                unexpectedError: 'Unexpected API response format.', openInGoogleMaps: 'Open in Google Maps', dataLoadError: 'Could not load factory data. Please ensure \'factory_data.js\' is included and correctly formatted.'
            },
            'ja': {
                appTitle: '燕三条 工場の祭典', appSubtitle: '下のリストをクリックすると地図が移動します。', openPlannerBtn: 'AIで訪問プランを作成',
                searchPlaceholder: '工場を検索...', filterTitle: '業種フィルター', selectAll: 'すべて選択', deselectAll: 'すべて解除',
                modalTitle: 'AI訪問プランナー', modalDesc: 'あなたの興味や時間、同伴者などの希望を自由に入力してください。AIがあなたにぴったりの見学プランを提案します。',
                modalExample: '例：「ナイフ作りが見たい」「半日で楽しめるコース」「家族連れにおすすめ」', modalPlaceholder: 'ここに希望を入力...',
                modalClose: '閉じる', modalGenerate: 'プランを生成', modalGenerating: '生成中...',
                errorPrompt: '希望を入力してください。', errorAPI: 'プランの生成中にエラーが発生しました。もう一度お試しください。',
                unexpectedError: '予期せぬAPI応答形式です。', openInGoogleMaps: 'Googleマップで開く', dataLoadError: '工場データを読み込めませんでした。「factory_data.js」が正しく設置されているか確認してください。'
            },
            'zh-TW': {
                appTitle: '燕三條工廠祭典', appSubtitle: '點擊下方工廠以在地圖上定位。', openPlannerBtn: '用 AI 規劃參觀路線',
                searchPlaceholder: '搜尋工廠...', filterTitle: '產業類別篩選', selectAll: '全部選取', deselectAll: '全部取消',
                modalTitle: 'AI 參觀路線規劃器', modalDesc: '請自由輸入您的興趣、時間、旅伴等偏好。AI 將會為您量身打造最合適的參觀計畫。',
                modalExample: '例如：「想看刀具製作」、「半日遊行程」、「適合親子共遊」', modalPlaceholder: '請在此輸入您的偏好...',
                modalClose: '關閉', modalGenerate: '生成計畫', modalGenerating: '生成中...',
                errorPrompt: '請輸入您的偏好。', errorAPI: '生成計畫時發生錯誤，請再試一次。',
                unexpectedError: '未預期的 API 回應格式。', openInGoogleMaps: '在 Google 地圖中開啟', dataLoadError: '無法載入工廠資料。請確認 \'factory_data.js\' 檔案已正確載入。'
            }
        };

        // Category translations
        const categoryTranslations = {
            'en': {
                '金属製品製造': 'Metal Products Manufacturing', '金属加工': 'Metal Processing', '金属部品製造': 'Metal Parts Manufacturing', '金属材料': 'Metal Materials',
                '金型': 'Molds/Dies', '木工': 'Woodworking', '食品製造': 'Food Manufacturing', '小売': 'Retail', '飲食': 'Food & Beverage',
                '小売・道の駅': 'Retail & Roadside Station', '道の駅': 'Roadside Station', '資料館': 'Museum', 'その他サービス': 'Other Services',
                '印刷パッケージ': 'Printing & Packaging', '金物卸売': 'Hardware Wholesale', '農家': 'Farm', 'default': 'Other'
            },
            'ja': {
                '金属製品製造': '金属製品製造', '金属加工': '金属加工', '金属部品製造': '金属部品製造', '金属材料': '金属材料',
                '金型': '金型', '木工': '木工', '食品製造': '食品製造', '小売': '小売', '飲食': '飲食',
                '小売・道の駅': '小売・道の駅', '道の駅': '道の駅', '資料館': '資料館', 'その他サービス': 'その他サービス',
                '印刷パッケージ': '印刷パッケージ', '金物卸売': '金物卸売', '農家': '農家', 'default': 'その他'
            },
            'zh-TW': {
                '金属製品製造': '金屬製品製造', '金属加工': '金屬加工', '金属部品製造': '金屬零件製造', '金属材料': '金屬材料',
                '金型': '模具', '木工': '木工', '食品製造': '食品製造', '小売': '零售', '飲食': '餐飲',
                '小売・道の駅': '零售・道之驛', '道の駅': '道之驛', '資料館': '資料館', 'その他サービス': '其他服務',
                '印刷パッケージ': '印刷包裝', '金物卸売': '五金批發', '農家': '農家', 'default': '其他'
            }
        };
        
        // --- Global Variables & App State ---
        let currentLanguage = 'zh-TW';
        let locations = [];
        const categoryColors = {
            '金属製品製造': '#1f77b4', '金属加工': '#ff7f0e', '金属部品製造': '#aec7e8', '金属材料': '#9467bd',
            '金型': '#ffbb78', '木工': '#8c564b', '食品製造': '#d62728', '小売': '#e377c2', '飲食': '#f7b6d2',
            '小売・道の駅': '#2ca02c', '道の駅': '#98df8a', '資料館': '#bcbd22', 'その他サービス': '#7f7f7f',
            '印刷パッケージ': '#c49c94', '金物卸売': '#dbdb8d', '農家': '#9edae5', 'default': '#cccccc'
        };
        let selectedCategories = new Set(Object.keys(categoryColors));

        // --- UI Elements ---
        const map = L.map('map').setView([37.64, 138.94], 11);
        const allMarkers = {};
        const allListItems = {};
        const visibleMarkersLayer = L.layerGroup().addTo(map);
        let categoryFilterControl = L.control({ position: 'bottomright' });
        const factoryListElement = document.getElementById('factory-list');
        const searchInput = document.getElementById('search-input');
        const clearSearchBtn = document.getElementById('clear-search-btn');
        
        // --- Core Functions ---
        const createSvgIcon = (color) => {
            const svgIconHtml = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28" fill="${color}" style="filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.5));"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`;
            return L.divIcon({ html: svgIconHtml, className: 'svg-icon', iconSize: [28, 28], iconAnchor: [14, 28], popupAnchor: [0, -28] });
        };
        
        function createAllElements(){
            locations.forEach(location => {
                const color = categoryColors[location.category] || categoryColors['default'];
                const icon = createSvgIcon(color);
                
                // Validate coordinates before creating marker
                if (location.lat && location.lng && !isNaN(location.lat) && !isNaN(location.lng)) {
                    const marker = L.marker([location.lat, location.lng], { icon: icon });
                    allMarkers[location.originalName] = marker;
                } else {
                    console.warn(`Invalid coordinates for ${location.name}: lat=${location.lat}, lng=${location.lng}`);
                    return;
                }

                const listItem = document.createElement('div');
                listItem.className = 'p-3 flex items-center bg-gray-50 hover:bg-blue-100 rounded-lg cursor-pointer transition duration-300';
                
                const displayName = location.multilingual[currentLanguage] || location.name;
                const displayCategory = categoryTranslations[currentLanguage][location.category] || location.category;
                
                listItem.innerHTML = `<span class="w-3 h-3 rounded-full mr-3 flex-shrink-0" style="background-color: ${color};"></span><div class="flex-grow"><h3 class="font-semibold text-sm text-blue-800">${displayName}</h3><p class="text-xs text-gray-500">${displayCategory}</p></div>`;
                
                listItem.addEventListener('click', () => {
                    if (allMarkers[location.originalName]) {
                        map.setView([location.lat, location.lng], 16);
                        allMarkers[location.originalName].openPopup();
                    }
                });
                allListItems[location.originalName] = listItem;
            });
        }
        
        function updateVisibleFactories() {
            visibleMarkersLayer.clearLayers();
            factoryListElement.innerHTML = '';
            
            const searchTerm = searchInput.value.toLowerCase();
            clearSearchBtn.classList.toggle('hidden', searchTerm.length === 0);

            const filteredLocations = locations.filter(location => {
                const nameMatch = location.name.toLowerCase().includes(searchTerm) ||
                                location.originalName.toLowerCase().includes(searchTerm);
                const categoryMatch = selectedCategories.has(location.category);
                return nameMatch && categoryMatch;
            });

            filteredLocations.forEach(location => {
                const displayName = location.multilingual[currentLanguage] || location.name;
                const displayCategory = categoryTranslations[currentLanguage][location.category] || location.category;
                
                // Check if marker exists before trying to use it
                if (allMarkers[location.originalName]) {
                    const popupHtml = `<div class="popup-content space-y-2"><h3 class="font-bold text-lg">${displayName}</h3><p class="text-gray-600">${displayCategory}</p><p class="text-sm text-gray-800">${location.address}</p><a href="${location.link}" target="_blank" class="font-semibold inline-block mt-1">${translations[currentLanguage].openInGoogleMaps} →</a></div>`;
                    allMarkers[location.originalName].bindPopup(popupHtml);
                    
                    visibleMarkersLayer.addLayer(allMarkers[location.originalName]);
                }
                
                // Check if list item exists before trying to use it
                if (allListItems[location.originalName]) {
                    factoryListElement.appendChild(allListItems[location.originalName]);
                }
            });
        }

        function changeLanguage(lang) {
            currentLanguage = lang;
            document.documentElement.lang = lang === 'zh-TW' ? 'zh-Hant' : lang;

            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (translations[lang][key]) el.textContent = translations[lang][key];
            });

            document.getElementById('user-prompt').placeholder = translations[lang].modalPlaceholder;
            searchInput.placeholder = translations[lang].searchPlaceholder;
            
            // Update locations data with new language
            locations = locations.map(location => ({
                ...location,
                name: location.multilingual[lang] || location.originalName,
                categoryDisplay: categoryTranslations[lang][location.category] || location.category
            }));
            
            // Recreate list items with new language
            Object.keys(allListItems).forEach(key => {
                const location = locations.find(loc => loc.originalName === key);
                if (location) {
                    const color = categoryColors[location.category] || categoryColors['default'];
                    const displayName = location.multilingual[lang] || location.originalName;
                    const displayCategory = categoryTranslations[lang][location.category] || location.category;
                    
                    allListItems[key].innerHTML = `<span class="w-3 h-3 rounded-full mr-3 flex-shrink-0" style="background-color: ${color};"></span><div class="flex-grow"><h3 class="font-semibold text-sm text-blue-800">${displayName}</h3><p class="text-xs text-gray-500">${displayCategory}</p></div>`;
                }
            });
            
            map.removeControl(categoryFilterControl);
            categoryFilterControl.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'category-filter p-4 rounded-lg shadow-lg');
                div.innerHTML = `<h4 class="font-bold mb-2">${translations[lang].filterTitle}</h4>
                    <div class="flex justify-between mb-2 text-sm">
                        <button id="select-all-btn" class="text-blue-600 hover:underline">${translations[lang].selectAll}</button>
                        <button id="deselect-all-btn" class="text-blue-600 hover:underline">${translations[lang].deselectAll}</button>
                    </div>
                    <div id="category-checkboxes"></div>`;
                
                const checkboxesContainer = div.querySelector('#category-checkboxes');
                Object.keys(categoryColors).filter(c => c !== 'default').sort().forEach(category => {
                    const item = document.createElement('div');
                    item.className = 'category-filter-item';
                    const displayCategory = categoryTranslations[lang][category] || category;
                    item.innerHTML = `
                        <input type="checkbox" id="cat-${category}" value="${category}" class="form-checkbox h-4 w-4 text-blue-600">
                        <div class="color-box" style="background-color:${categoryColors[category]}"></div>
                        <label for="cat-${category}" class="text-sm">${displayCategory}</label>
                    `;
                    checkboxesContainer.appendChild(item);
                    const checkbox = item.querySelector('input');
                    checkbox.checked = selectedCategories.has(category);
                    checkbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            selectedCategories.add(e.target.value);
                        } else {
                            selectedCategories.delete(e.target.value);
                        }
                        updateVisibleFactories();
                    });
                });
                
                L.DomEvent.disableClickPropagation(div);
                return div;
            };
            categoryFilterControl.addTo(map);

            setTimeout(() => {
                document.getElementById('select-all-btn').addEventListener('click', () => {
                    selectedCategories = new Set(Object.keys(categoryColors));
                    document.querySelectorAll('.category-filter-item input').forEach(cb => cb.checked = true);
                    updateVisibleFactories();
                });
                document.getElementById('deselect-all-btn').addEventListener('click', () => {
                    selectedCategories.clear();
                    document.querySelectorAll('.category-filter-item input').forEach(cb => cb.checked = false);
                    updateVisibleFactories();
                });
            }, 0);

            updateVisibleFactories();
        }

        // --- Event Listeners and Initializers that depend on data ---
        function initializeApp() {
            // This now runs only after factoryData is loaded and processed.
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>' }).addTo(map);

            createAllElements();

            // Setup event listeners that don't depend on language
            searchInput.addEventListener('input', updateVisibleFactories);
            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                updateVisibleFactories();
            });
            document.getElementById('language-switcher').addEventListener('change', (e) => changeLanguage(e.target.value));

            // Initial UI setup with default language
            changeLanguage('zh-TW'); 
        }

        // --- Main App Entry Point ---
        window.onload = () => {
            if (typeof factoryData !== 'undefined') {
                locations = factoryData.filter(item => {
                    // Validate coordinates to prevent map projection errors
                    return item.api_lat != null && item.api_lng != null && 
                           !isNaN(item.api_lat) && !isNaN(item.api_lng) &&
                           item.api_lat >= -90 && item.api_lat <= 90 &&
                           item.api_lng >= -180 && item.api_lng <= 180;
                }).map(item => {
                    // Use helper functions if available, otherwise use our own translations
                    const getTranslatedName = (lang) => {
                        if (item.names && item.names[lang]) return item.names[lang];
                        if (typeof getNameTranslation === 'function') return getNameTranslation(item.name, lang);
                        return item.name;
                    };
                    
                    const getTranslatedCategory = (lang) => {
                        if (item.categories && item.categories[lang]) return item.categories[lang];
                        if (typeof getCategoryTranslation === 'function') return getCategoryTranslation(item.category, lang);
                        return categoryTranslations[lang] ? categoryTranslations[lang][item.category] || item.category : item.category;
                    };
                    
                    return {
                        name: getTranslatedName(currentLanguage),
                        originalName: item.name,
                        city: item.city, 
                        category: item.category,
                        categoryDisplay: getTranslatedCategory(currentLanguage),
                        lat: parseFloat(item.api_lat), 
                        lng: parseFloat(item.api_lng), 
                        address: item.api_found_address.replace('日本、', ''),
                        link: item.google_maps_link,
                        multilingual: {
                            ja: getTranslatedName('ja'),
                            en: getTranslatedName('en'),
                            'zh-TW': getTranslatedName('zh-TW')
                        }
                    };
                });
                
                initializeApp();
            } else {
                console.error("Factory data not loaded. Make sure factory_data.js is included correctly.");
                document.getElementById('factory-list').innerHTML = `<p class="p-4 text-red-500">${translations[currentLanguage].dataLoadError}</p>`;
            }
        };
    </script>
</body>
</html>
